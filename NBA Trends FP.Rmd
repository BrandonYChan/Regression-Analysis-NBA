---
title: "Regression Analysis on NBA Claims"
author: "Brandon Chan, Brayden Van De Wynckel"
date: "2024-11-13"
output:
  html_document: 
    df_print: kable 
  pdf_document: default
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(tibble.print_min = 4, tibble.print_max = 10)
# install.packages("MASS") 
# install.packages("leaps") 
# install.packages("DT") 
# install.packages("pander") 
library(MASS)
library(tidyverse)
library(leaps) 
library(knitr) 
library(pander) 
library(DT)
select <- dplyr::select 
```

# Index 
```{r}
index <- tibble(
  Order = c("1. ", "2. ", "3. ", "4. ", "5. ", "6. "),
  Item = c("Objectives", "Hypothesis Test", "Stat Selection", "Model Testing", "Impact of Defense", "Conclusions") 
)
index 
```



# Objective  
Many older NBA fans like to make claims about how the league was different back in their day. They often criticize today's game for the high frequency of threes attempted. Many speculate why this is the case, but clear explanations are not often provided. The aim of this analysis is to see how the number of threes attempted has changed over the years, and why these changes have taken place.  

## Data Description 
The data is from basketballreference.com and includes all seasons in NBA history. This particular dataset includes many common stats (ex. points, offensive rating), taken as the league average of per-game stats of <b>teams</b> for a given season. For example the PTS stat in the 2023-24 season represents that average points per game scored by a team in a single game.
```{r}
league_df <- read_csv("https://raw.githubusercontent.com/BrandonYChan/ballindata/refs/heads/master/static/CSV/League/per100_league.csv", show_col_types = FALSE) %>%
  filter(Season >= "1950-51") %>% 
  select(-c(Rk, Lg))
datatable(league_df, options=list(autoWidth=TRUE), width="80%")  
```

```{r}
# The following is a breakdown of each category within the dataset.
# Season: The specific NBA season (e.g., 2023-24).
# Age: The average age of players in the league for that season.
# Ht (Height): The average height of players, typically represented in feet and inches.
# Wt (Weight): The average weight of players in pounds.
# G (Games): The total number of games played in the season.
# MP (Minutes Played): The average total minutes played per game by all teams combined.
# FG (Field Goals): The average number of field goals made per game.
# FGA (Field Goal Attempts): The average number of field goal attempts per game.
# 3P (3-Point Field Goals): The average number of 3-point field goals made per game.
# 3PA (3-Point Attempts): The average number of 3-point field goal attempts per game.
# FT (Free Throws): The average number of free throws made per game.
# FTA (Free Throw Attempts): The average number of free throw attempts per game.
# ORB (Offensive Rebounds): The average number of offensive rebounds per game.
# DRB (Defensive Rebounds): The average number of defensive rebounds per game.
# TRB (Total Rebounds): The average number of total rebounds (offensive + defensive) per game.
# AST (Assists): The average number of assists per game.
# STL (Steals): The average number of steals per game.
# BLK (Blocks): The average number of blocks per game.
# TOV (Turnovers): The average number of turnovers per game.
# PF (Personal Fouls): The average number of personal fouls per game.
# PTS (Points): The average total points scored per game.
# FG% (Field Goal Percentage): The shooting percentage for field goals (FG/FGA).
# 3P% (3-Point Percentage): The shooting percentage for 3-point field goals (3P/3PA).
# FT% (Free Throw Percentage): The shooting percentage for free throws (FT/FTA).
# Pace: The average number of possessions per 48 minutes, indicating the speed of play.
# eFG% (Effective Field Goal Percentage): A shooting metric that adjusts for the higher value of 3-point shots, calculated as (FG+0.5*P)/FGA
# TOV% (Turnover Percentage): The percentage of possessions ending in turnovers.
# ORB% (Offensive Rebound Percentage): The percentage of available offensive rebounds a team secures.
# FT/FGA (Free Throw Attempts Per Field Goal Attempt): The ratio of free throw attempts to field goal attempts.
# ORtg (Offensive Rating): The number of points scored per 100 possessions.
# TS% (True Shooting Percentage): A measure of shooting efficiency that considers field goals, 3-point field goals, and free throws, calculated as PTS/(2*(FGA+0.44*FTA))
```

## Testing the Claim that Players Attempts More Threes

We are going to start by evaluating the claim that players shoot more threes in today's game than in past decades. This can be expressed more formally with a hypothesis test. 

Claim: Players shoot more threes in the current decade than in past decades. 
We will take the mean number of threes attempted in the 2020's and compare it to the mean number of threes in the 1990's as estimates. 
```{r}
# Group by decade 
df_3s <- league_df %>% 
  mutate(Decade = paste(substr(Season, 6, 6), "0's", sep=""))

# Get mean 3's for each decade 
decade3s <- df_3s %>% 
  group_by(Decade) %>% 
  filter(!(Decade %in% c("50's", "60's", "70's"))) %>% 
  summarise(Mean3s = mean(`3PA`)) %>% 
  arrange(desc(Mean3s)) 
decade3s 

mean3s_2020s <- decade3s %>% 
  filter(Decade=="20's") %>% 
  select(Mean3s) %>% 
  pull() 

means3s_1990s <- decade3s %>% 
  filter(Decade=="90's") %>% 
  select(Mean3s) %>% 
  pull() 

mu <- mean(decade3s$Mean3s)

# Parameters for hypothesis test 
sigma_1 <- df_3s %>% 
  filter(Decade=="20's") %>% 
  summarise(sd(`3PA`)) %>% 
  pull()
  
sigma_2 <- df_3s %>% 
  filter(Decade=="90's") %>% 
  summarise(sd(`3PA`)) %>% 
  pull()  


n <- df_3s %>% 
  filter(Decade=="20's") %>% 
  select(Decade) %>% 
  count() %>% 
  pull() 
m <- df_3s %>% 
  filter(Decade=="90's") %>% 
  select(Decade) %>% 
  count() %>% 
  pull() 

# Observed test statistic 
t_obs <- ((mean3s_2020s - means3s_1990s)-0)/sqrt(sigma_1^2/n + sigma_2^2/m) 

# Evaluated at 95% significance 
t_alpha <- qt(0.05, n-1, lower.tail = FALSE)
```
$H_0$: Mean # 3's in the 2020's ($M_{2020s}$) = Mean # 3s in the 1990's ($M_{1990s}$)

$H_A$: Mean # 3's in the 2020's > Mean # 3s in the 1990's 

$$t_{obs} = \frac{((M_{2020s} - M_{1990s})-0)}{\sqrt{\frac{\sigma_1^2}{n} + \frac{\sigma_2^2}{m}}}$$  
$$t_{obs} = \frac{12.56 - 4.25}{\sqrt{\frac{0.3361547^2}{5} + \frac{1.726429^2}{10}}}$$ 

At 95% significance: $t_{0.025, 4} = 2.131847$
$$ t_{obs} > t_{\alpha, n-1} $$
So we reject the null hypothesis: Players do shoot more threes in the current decade than in the past. 


## Plotting Changes in 3-Pointers Made  
The evidence strongly suggests that players take more 3s than in the past. We verify this with a visualization: 
```{r}
df_3s <- league_df %>% 
  filter(!is.na(Pace), !is.na(`3PA`), !is.na(`3P%`)) %>% 
  select(Season,`3PA`, `3P%`) 

df_3s %>% 
  ggplot(aes(Season, `3PA`, group=1)) + 
  geom_point() + 
  geom_line() +
  scale_x_discrete(breaks=c("1979-80", "1989-90", "1999-00", "2009-10", "2019-20")) + 
  ggtitle("3-Pointers Made Per-Game Increases Almost Every Season") + 
  labs(caption = "3-pt line distance decreased from 1994 to 1997")

```

It is clear that players take more threes in almost every passing season since the addition of the three point line to the NBA game in 1979. This leads to the question; why are players taking more threes?

## Stat Selection to Predict Threes Attempted  

The following variables/stats will be removed due to linear dependencies or irrelevance to the analysis: Season, Ht, 3P, 3P%, FG, FGA, FG%, FT/FGA, eFG%, TS%. 
```{r}
# Remove variables with direct linear dependencies 
df_pred3 <- league_df %>% 
  select(-c(Season, Ht, `3P`, `3P%`, FG, FGA, `FG%`, `FT/FGA`, `eFG%`, `TS%`))
```

The best stats to predict 3PA will be selected using backwards elmination using BIC (Bayesian Information Criterion).  
```{r, include=FALSE}
best_subsets_3s <- regsubsets(`3PA`~., df_pred3, method="backward")   
best_summary_3s <- summary(best_subsets_3s)
```

```{r}
plot(best_summary_3s$bic, 
     main="5 Stats Should be Used to Predict 3PA",
     xlab = "Number of Variables", 
     ylab = "BIC", 
     type = "b"
) 
```

## Selecting the Best 5 Variables 

Based on the variable selection process, these 5 statistics were evaluated to be the most important for predicting the number of threes attempted by a team in a game: TRB (total rebounds), STL (steals), TOV (turnovers), PTS (points), ORB% (offensive rebound percentage).  
```{r, include=FALSE}
best_coefs <- coef(best_subsets_3s, 5) 
coef_names <- names(best_coefs) 
coef_names 
```
## Creating the Model 

The fitted model was created using least-squares linear regression. 

$$ \widehat{3PA} = -458.13 + 4.21TRB + 1.49STL + 4.97TOV + 2.59PTS -2.89ORB\% $$

```{r}
model_3s <- lm(`3PA` ~ TRB+STL+TOV+PTS+`ORB%` , df_pred3) 
# summary(model_3s) 
```


```{r}
fit_3PA <-rev(fitted(model_3s))

plot(seq(length(df_3s$Season)), rev(df_3s$`3PA`),
     main="Model Prediction Appear to be Very Accurate",
     xlab="Season",
     ylab="3-Pt Attempts Per Game"
     ) 
lines(seq(length(df_3s$Season)), fit_3PA)
```

ANOVA Table 

```{r include=FALSE}
anova(model_3s)
```

```{r}
SS_reg = 921.71+2454.16+468.44+159.17+524.30 
SS_res = 20.23 
SS_tot = SS_reg+SS_res 
DF = c(5, 39, 5+39)
SS = c(SS_reg, SS_res, SS_tot) 
MS = SS/DF 

ANOVA_table = tibble(
  Label = c("Regression", "Residual", "Total"), 
  DF, SS, MS 
)
ANOVA_table
```


----------------------------------------------------------------------------------------------------------------------------------------
## Why are there more 3 point shots attempted?
Is the reason teams are taking more 3 point attempts because teams are defending better making driving to the rim and scoring even harder as the league progresses? 
In order to determine if this is true we'll regress various common defensive stats taken league-wide to see if better defence leads to more 3 point attemots taken.

```{r}
lm_defence <- lm(`3PA`~STL+TOV+BLK+DRB, league_df)
summary(model_3s)
```

```{r}
anova(lm_defence)
```

```{r}
confint(lm_defence, level=0.95)
```

```{r}
plot(league_df$STL, league_df$`3PA`, 
       main="More Steals Lead to Fewer Threes Attempted",
       xlab="Steals Per Game",
       ylab="3PA Per Game"
)
abline(lm(`3PA`~STL, league_df))
```

```{r}
plot(league_df$TOV, league_df$`3PA`, 
       main="More Turnovers Coincide with Fewer Threes Attempted",
       xlab="Turnovers Per Game",
       ylab="3PA Per Game"
)
abline(lm(`3PA`~TOV, league_df))
```

```{r}
plot(league_df$BLK, league_df$`3PA`)
abline(lm(`3PA`~BLK, league_df))
```

```{r}
plot(league_df$DRB, league_df$`3PA`)
abline(lm(`3PA`~DRB, league_df))
```

Based on this output, the opposite appears to be true. As defence gets better 3 point appempts go down. This could also be that due to better defence, teams feel less safe taking deeper shots as well as open shots being much less frequent, fewer 3 point attempts are made. The only discrepancy being that as more 3 point appempts are taken, more defensive rebounds are made which could just be attributed to when teams on offence are all at the 3 point line hoping to shoot the defence is more likely to recover missed shots as theyre closer to the rim meaning they're faster to grab any rebounds


## Offensive vs defensive rebounds
Now let's see if a relationship exists between offensive and defensive rebounds to determine if when teams are picking up more rebounds on one side of the court are they picking up fewer on the other side. The implications this has for our experiment are that are when teams are on offence vs defence how do their playstyles change? So for example if when a team is on offence and their playstyle is to just have everyone hover around the 3 point line looking to shoot they won't be able to get as many offensive rebounds. Compared to when theyre on defence if they're still able to get a lot of rebounds showing their capability to rebound then that is good evidence that they aren't as worried about offensive rebounds and are simply trusting their 3 point shooting.

```{r}
of_df <- lm(ORB~DRB, league_df)
summary(of_df)
```

```{r}
confint(of_df, level=0.95)
```

```{r}
plot(league_df$DRB, league_df$ORB)
abline(lm(ORB~DRB, league_df))
```

Based on these results we can say with reasonable confidence that a relationship exists between the number of defensive rebounds vs the number of offensive rebounds. Where as the number of defensive rebounds increases, the number of offensive rebounds decreases. 

# Conclusions 

The number of threes attempts has been steadily increasing in almost every season since the inception of the three point line in 1979. We were able to determine several reason why this may be the case, including changes in related statistics and the impact of defense. Using what we discovered in the analysis we can now have a clear hypothesis for why the number of threes has skyrocketed throughout the decades:

Attempting more threes makes guarding more difficult for defenses, leading to lower block and steal numbers. While the number of offensive rebounds decreases when having a spaced-out offense, scoring still increases when attempting more threes. Attempting more threes also appears to be less risky and lead to fewer turnovers, which can be costly for teams. To summarise, it appears that shooting more threes makes offenses better and defenses worse, which incentivises to take more of them. 








